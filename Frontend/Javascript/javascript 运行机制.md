# javascript 运行机制

## 进程和线程

```js
- 工厂的资源 -> 系统分配的内存（独立的一块内存）

- 工厂之间的相互独立 -> 进程之间相互独立

- 多个工人协作完成任务 -> 多个线程在进程中协作完成任务

- 工厂内有一个或多个工人 -> 一个进程由一个或多个线程组成

- 工人之间共享空间 -> 同一进程下的各个线程之间共享程序的内存空间（包括代码段、数据集、堆等）
```

- 进程是 CPU 资源分配的最小单位
- 线程是 CPU 调度的最小单位

## 浏览器是多进程的

- Browser 进程：浏览器的主进程，只有一个
- 第三方插件进程：每种类型的插件对应一个进程，仅当使用插件时才创建
- GPU 进程：最多一个，用于 3D 绘制
- 浏览器渲染进程：默认每一个 Tab 页面一个进程，互不影响

> 在浏览器中打开一个网页相当于新起了一个进程
>
> 浏览器有时会将多个进程合并

## 渲染进程

页面的渲染、JS 的执行、事件的循环都在这个进程内进行

包含的线程： 

1. GUI 渲染线程
2. JS 引擎线程
3. 事件触发线程
   - 归属浏览器而不是 JS 引擎，用来控制事件循环
4. 定时触发线程
   - setInterval 和 setTimeout 所在线程
   - 浏览器定时计数器不是由 JS 引擎计数的，是通过单独的线程来计时并触发定时
   - 如果处于阻塞线程状态就会影响计时的准确
5. 异步 Http 请求线程
   - 在 XMLHttpRequest 在连接后是通过浏览器新开一个线程请求
   - 若有回调函数，将这个回调函数放入到事件队列中

> 注意：GUI 线程和 JS 线程是互斥的

### 为什么是单线程的语言？

单线程就是程序的执行顺序是自上而下的，同一时间只有一段代码被执行。多线程会在同一时间运行多段代码，使 CPU 能够充分利用，提高效率，那么为何不采用多线程的机制呢？

JS 主要用来处理用户与页面产生的交互，如果采用多线程的方式操作 DOM，一个线程要修改 DOM，另一个线程要删除 DOM，这样浏览器就不知去进行什么操作了。

### 什么是事件轮询？

在讲事件轮询之前，先介绍几个概念：同步任务、异步任务、执行栈、任务队列

- JS 分为同步任务和异步任务
- 同步任务都在主线程上执行，形成一个**执行栈**
- 主线程之外，事件触发线程管理一个**任务队列**，只要异步任务有了运行结果，就在**任务队列**中放置一个事件
- 一旦**执行栈**中的所有同步任务执行完后，就会去任务队列中读取，将可运行的异步任务推到**执行栈**中开始执行

## macrotask && microtask

macrotask （又称宏任务）：每次执行执行栈的代码就是一个宏任务（包括从事件队列中获取的）

microtask（又称微任务）：当宏任务执行结束后立即执行的任务

## WebWorker



参考文章：

1. [从浏览器多进程到JS单线程，JS运行机制最全面的一次梳理](https://juejin.im/post/5a6547d0f265da3e283a1df7)
2. [JavaScript 单线程和异步机制](https://juejin.im/entry/57b2827f165abd005434c59e)